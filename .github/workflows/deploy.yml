name: Deploy to Production Server

on:
  push:
    branches:
      - master
      - main

env:
  SSH_HOST: ${{ vars.SSH_HOST }}
  SSH_USER: ${{ vars.SSH_USER }}
  DEPLOY_PATH: ${{ vars.DEPLOY_PATH || '/home/pdfmerger/pdf-editor' }}
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION || '3.9' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          if [ -z "${{ env.SSH_HOST }}" ]; then
            echo "Error: SSH_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ env.SSH_USER }}" ]; then
            echo "Error: SSH_USER variable is not set"
            exit 1
          fi
          echo "✓ Configuration validated"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Build frontend
        run: |
          cd frontend
          yarn install
          
          # Build the production bundle
          echo "Building production bundle..."
          CI=false npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy_package
          cp -r backend deploy_package/
          cp -r frontend/build deploy_package/frontend
          
          # Create deployment script for our Apache + systemd setup
          cat > deploy_package/deploy.sh << 'DEPLOYSCRIPT'
          #!/bin/bash
          # Deployment script for PDF Editor
          
          set -e
          
          # Get the directory where this script is located (the extracted temp dir)
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          
          echo "=== PDF Editor Deployment ==="
          echo "Deployment path: $DEPLOY_PATH"
          echo "Source path: $SCRIPT_DIR"
          
          # Stop backend service
          echo "Stopping backend service..."
          systemctl --user stop pdfmerger || true
          
          # Backup existing files
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "Creating backup..."
          if [ -d "$DEPLOY_PATH/backend" ]; then
            mv "$DEPLOY_PATH/backend" "$DEPLOY_PATH/backend_backup_$TIMESTAMP"
          fi
          if [ -d "$DEPLOY_PATH/frontend" ]; then
            mv "$DEPLOY_PATH/frontend" "$DEPLOY_PATH/frontend_backup_$TIMESTAMP"
          fi
          
          # Copy new files
          echo "Copying new files..."
          cp -r "$SCRIPT_DIR/backend" "$DEPLOY_PATH/"
          cp -r "$SCRIPT_DIR/frontend" "$DEPLOY_PATH/"
          
          # Set proper permissions
          echo "Setting permissions..."
          chmod -R 755 "$DEPLOY_PATH"
          
          # Install Python dependencies
          echo "Installing Python dependencies..."
          cd "$DEPLOY_PATH/backend"
          if [ -d "venv" ]; then
            echo "Using existing virtual environment"
            source venv/bin/activate
            pip install -r requirements.txt
          else
            echo "Creating new virtual environment"
            python${PYTHON_VERSION} -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
          fi
          deactivate
          
          # Deploy frontend (copy to web-accessible location)
          echo "Deploying frontend..."
          if [ -d "/var/www/pdf.malahieude.net/frontend" ]; then
            rm -rf /var/www/pdf.malahieude.net/frontend/*
            cp -r "$DEPLOY_PATH/frontend/build/"* /var/www/pdf.malahieude.net/frontend/
          else
            echo "Warning: /var/www/pdf.malahieude.net/frontend not accessible, skipping frontend deployment to Apache"
          fi
          
          # Restart services
          echo "Restarting services..."
          systemctl --user restart pdfmerger || echo "Warning: Could not restart pdfmerger service"
          
          # Verify backend service
          echo "Verifying backend service..."
          if systemctl --user is-active --quiet pdfmerger; then
            echo "✓ Backend service is running"
          else
            echo "✗ Backend service failed to start"
            systemctl --user status pdfmerger || true
            exit 1
          fi
          
          echo "✓ Deployment completed successfully!"
          echo "Frontend: https://pdf.malahieude.net"
          echo "Backend: https://pdf-api.malahieude.net"
          DEPLOYSCRIPT
          
          chmod +x deploy_package/deploy.sh
          
          # Create archive
          tar -czf deploy.tar.gz -C deploy_package .

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          # Create unique temporary directory on server for security
          TEMP_DIR=$(ssh -i ~/.ssh/deploy_key ${{ env.SSH_USER }}@${{ env.SSH_HOST }} 'mktemp -d')
          echo "Using temporary directory: $TEMP_DIR"
          
          scp -i ~/.ssh/deploy_key deploy.tar.gz \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:$TEMP_DIR/

      - name: Deploy on server
        run: |
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          PYTHON_VERSION="${{ env.PYTHON_VERSION }}"
          ssh -i ~/.ssh/deploy_key \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "export DEPLOY_PATH='$DEPLOY_PATH' PYTHON_VERSION='$PYTHON_VERSION' && bash -s" << 'EOF'
            set -e
            
            # Get temp directory with deployment package
            TEMP_DIR=$(ls -td /tmp/tmp.* 2>/dev/null | head -1)
            
            if [ -z "$TEMP_DIR" ] || [ ! -f "$TEMP_DIR/deploy.tar.gz" ]; then
              echo "Error: Deployment package not found"
              exit 1
            fi
            
            echo "Using DEPLOY_PATH=\"$DEPLOY_PATH\" PYTHON_VERSION=\"$PYTHON_VERSION\""
            echo "Extracting deployment package..."
            tar -xzf "$TEMP_DIR/deploy.tar.gz" -C "$TEMP_DIR"
            
            # Run deployment script with environment variables
            echo "Running deployment script..."
            cd "$TEMP_DIR"
            ./deploy.sh
            
            # Cleanup temporary directory
            rm -rf "$TEMP_DIR"
            
            echo "Deployment completed!"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
