name: Deploy to Server

on:
  push:
    branches:
      - master

env:
  SSH_HOST: ${{ vars.SSH_HOST }}
  SSH_USER: ${{ vars.SSH_USER }}
  DEPLOY_PATH: ${{ vars.DEPLOY_PATH || '/opt/pdf-editor' }}
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION || '3.11' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy_package
          cp -r backend deploy_package/
          cp -r frontend/build deploy_package/frontend
          
          # Create a deployment script
          cat > deploy_package/start.sh << 'STARTSCRIPT'
          #!/bin/bash
          # Start script for PDF Editor
          
          # Kill any existing processes
          pkill -f "uvicorn main:app" || true
          
          # Start backend
          cd backend
          nohup python -m uvicorn main:app --host 0.0.0.0 --port 8000 > ../backend.log 2>&1 &
          echo $! > ../backend.pid
          
          echo "Backend started on port 8000 (PID: $(cat ../backend.pid))"
          echo "Frontend static files available in frontend/ directory"
          STARTSCRIPT
          
          chmod +x deploy_package/start.sh
          
          # Create a stop script
          cat > deploy_package/stop.sh << 'STOPSCRIPT'
          #!/bin/bash
          # Stop script for PDF Editor
          
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
            echo "Backend stopped"
          else
            pkill -f "uvicorn main:app" || true
            echo "Stopped any running backend processes"
          fi
          STOPSCRIPT
          
          chmod +x deploy_package/stop.sh
          
          # Create archive
          tar -czf deploy.tar.gz -C deploy_package .

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to server
        run: |
          scp -i ~/.ssh/deploy_key deploy.tar.gz \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/

      - name: Deploy on server
        run: |
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          PYTHON_VERSION="${{ env.PYTHON_VERSION }}"
          ssh -i ~/.ssh/deploy_key \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            bash -s << EOF
            set -e
            
            # Create deployment directory
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
            
            # Stop existing server if running
            if [ -f stop.sh ]; then
              echo "Stopping existing server..."
              ./stop.sh
            fi
            
            # Extract new version
            tar -xzf /tmp/deploy.tar.gz -C "$DEPLOY_PATH"
            
            # Install Python dependencies
            cd backend
            echo "Installing Python dependencies..."
            python$PYTHON_VERSION -m pip install --user -r requirements.txt
            cd ..
            
            # Start the server
            echo "Starting server..."
            ./start.sh
            
            # Wait a moment for startup
            sleep 2
            
            # Check if backend is running
            if [ -f backend.pid ]; then
              if ps -p \$(cat backend.pid) > /dev/null; then
                echo "✓ Backend is running (PID: \$(cat backend.pid))"
              else
                echo "✗ Backend failed to start"
                cat backend.log
                exit 1
              fi
            fi
            
            # Cleanup
            rm -f /tmp/deploy.tar.gz
            
            echo "Deployment completed successfully!"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
